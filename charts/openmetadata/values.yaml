image:
  repository: openmetadata/server
  tag: 1.7.1
  pullPolicy: IfNotPresent

service:
  type: LoadBalancer

openmetadata:
  config:
    clusterName: openmetadata
    openmetadata:
      host: "0.0.0.0"
      port: 8585
      adminPort: 8586
      uri: "http://openmetadata:8585"

    database:
      host: mysql.daap-dev.svc.cluster.local
      port: 3306
      enabled: true
      driverClass: com.mysql.cj.jdbc.Driver
      dbScheme: mysql
      databaseName: openmetadata_db
      auth:
        username: openmetadata_user
        password:
          secretRef: mysql-secrets
          secretKey: openmetadata-mysql-password
      dbParams: "allowPublicKeyRetrieval=true&useSSL=false&serverTimezone=UTC"

    pipelineServiceClientConfig:
      enabled: true
      className: "org.openmetadata.service.clients.pipeline.airflow.AirflowRESTClient"
      apiEndpoint: http://132.196.174.193:8080
      metadataApiEndpoint: http://openmetadata:8585/api
      verifySsl: "no-ssl"
      hostIp: ""
      ingestionIpInfoEnabled: false
      healthCheckInterval: 300
      sslCertificatePath: "/no/path"
      auth:
        enabled: true
        username: admin
        password:
          secretRef: airflow-secrets
          secretKey: openmetadata-airflow-password
        trustStorePath: ""
        trustStorePassword:
          secretRef: ""
          secretKey: ""

    elasticsearch:
      enabled: true
      searchType: opensearch
      host: "opensearch-cluster-master.daap-dev.svc.cluster.local"
      port: 9200
      scheme: http
      trustStore:
        enabled: false
        path: ""
        password:
          secretRef: elasticsearch-truststore-secrets
          secretKey: openmetadata-elasticsearch-truststore-password
      auth:
        enabled: true
        username: "admin"
        password:
          secretRef: elasticsearch-secrets
          secretKey: openmetadata-elasticsearch-password

  pod:
    extraInitContainers:
      - name: create-opensearch-indices
        image: curlimages/curl:8.5.0
        command:
          - sh
          - -c
          - |
            echo "Waiting for OpenSearch..."
            until curl -u admin:$$(cat /usr/share/opensearch-password) -s http://opensearch-cluster-master.daap-dev.svc.cluster.local:9200; do
              sleep 5
            done

            echo "Creating OpenSearch indices..."
            for index in user_search_index team_search_index table_search_index topic_search_index dashboard_search_index pipeline_search_index mlmodel_search_index; do
              echo "Ensuring index: $index"
              curl -u admin:$$(cat /usr/share/opensearch-password) -X PUT "http://opensearch-cluster-master.daap-dev.svc.cluster.local:9200/$index" \
                   -H 'Content-Type: application/json' \
                   -d '{}'
            done
        volumeMounts:
          - name: opensearch-password
            mountPath: /usr/share
            readOnly: true

    volumes:
      - name: opensearch-password
        secret:
          secretName: elasticsearch-secrets
          items:
            - key: openmetadata-elasticsearch-password
              path: opensearch-password

persistence:
  enabled: true
  size: 1Gi
  accessModes:
    - ReadWriteOnce
  storageClass: managed-csi
