FROM apache/airflow:2.10.5-python3.11

# Install system dependencies first
USER root
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    build-essential \
    python3-dev \
    && rm -rf /var/lib/apt/lists/*
USER airflow

# Install Python packages in stages
RUN pip install --no-cache-dir "apache-airflow==2.10.5"

# Install providers
RUN pip install --no-cache-dir \
    "apache-airflow-providers-fab>=4.2.0"\
    "apache-airflow-providers-common-sql>=1.7.0" \
    "apache-airflow-providers-openlineage>=1.8.0"

# Install OpenMetadata components
RUN pip install --no-cache-dir \
    "openmetadata-ingestion[airflow]==1.6.6" \
    "openmetadata-managed-apis==1.6.6" \
    "pyarrow>=10.0.1,<10.1.0"

EXPOSE 8080

# Note: Auth manager should be configured via environment variables at runtime
CMD ["airflow", "webserver", "--port", "8080", "--host", "0.0.0.0"]