FROM apache/airflow:2.10.5-python3.11

# Set environment variables
ENV AIRFLOW_HOME=/opt/airflow
ENV AIRFLOW__CORE__AUTH_MANAGER=airflow.auth.managers.rbac_auth_manager.RBACAuthManager

# Install required packages
RUN pip install --no-cache-dir \
    "apache-airflow==2.10.5" \
    "apache-airflow-providers-fab==4.5.0" \  
    "apache-airflow-providers-common-sql>=1.7.0" \ 
    "apache-airflow-providers-openlineage>=1.8.0" \
    "openmetadata-ingestion[airflow]==1.6.6" \
    "openmetadata-managed-apis==1.6.6" \
    "pyarrow>=10.0.1,<10.1.0"

# Ensure proper permissions
USER root
RUN mkdir -p ${AIRFLOW_HOME} && chown -R airflow:airflow ${AIRFLOW_HOME}
USER airflow

EXPOSE 8080

CMD ["airflow", "webserver", "--port", "8080", "--host", "0.0.0.0"]