FROM apache/airflow:2.10.5-python3.11

# Install system dependencies
USER root
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    build-essential \
    python3-dev \
    && rm -rf /var/lib/apt/lists/*
USER airflow

# Install required providers and packages
RUN pip install --no-cache-dir \
    "apache-airflow-providers-flask-app-builder>=1.2.0" \
    "apache-airflow-providers-postgres>=5.6.0" \
    "apache-airflow-providers-openlineage>=1.8.0" \
    "openmetadata-ingestion[airflow]==1.6.6" \
    "openmetadata-managed-apis==1.6.6" \
    "pyarrow>=10.0.1,<10.1.0"

# Set critical environment variables
ENV AIRFLOW__CORE__AUTH_MANAGER=airflow.auth.managers.rbac_auth_manager.RBACAuthManager
ENV AIRFLOW__API__AUTH_BACKENDS=airflow.api.auth.backend.basic_auth
ENV AIRFLOW__WEBSERVER__WORKERS=2
ENV AIRFLOW__WEBSERVER__WORKER_REFRESH_INTERVAL=1800

# Health check
HEALTHCHECK --interval=30s --timeout=30s --start-period=60s \
  CMD curl -f http://localhost:8080/health || exit 1

EXPOSE 8080

# Entrypoint remains the default from base image