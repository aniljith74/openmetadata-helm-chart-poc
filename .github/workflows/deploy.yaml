name: Deploy OpenMetadata Stack to AKS

on:
  push:
    branches:
      - main
    paths:
      - "charts/openmetadata/**"
      - ".github/workflows/deploy.yaml"
      - "DockerDockerfile-openmetadata"
      - "Dockerfile-airflow"

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AZURE_CLUSTER_NAME: aks-dev-data-service 
      AZURE_RESOURCE_GROUP: aks-dev-data-service_group
      AZURE_REGION: your-region
      NAMESPACE: daap-dev

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set AKS context
      uses: azure/aks-set-context@v3
      with:
        resource-group: ${{ env.AZURE_RESOURCE_GROUP }}
        cluster-name: ${{ env.AZURE_CLUSTER_NAME }}

    - name: Log in to ACR
      uses: azure/docker-login@v1
      with:
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}
        login-server: daappoc25.azurecr.io

    - name: Build and push docker
      run:  |
        #docker build -t daappoc25.azurecr.io/openmetadata:custom -f Dockerfile-openmetadata .
        docker build -t daappoc25.azurecr.io/airflow:custom  -f Dockerfile-airflow .
        #docker push daappoc25.azurecr.io/openmetadata:custom
        docker push daappoc25.azurecr.io/airflow:custom     
      

    - name: Create Namespace /optional
      run: |
        kubectl get namespace $NAMESPACE || kubectl create namespace $NAMESPACE
    
    - name: Add Helm Repositories
      run: |
          helm repo add open-metadata https://helm.open-metadata.org 
          helm repo add opensearch https://opensearch-project.github.io/helm-charts
          helm repo add apache-airflow https://airflow.apache.org
          helm repo update


    - name: Deploy MySQL
      run: |
        kubectl apply -f charts/openmetadata/mysql.yaml -n $NAMESPACE
        kubectl rollout status statefulset/mysql -n $NAMESPACE --timeout=180s

    - name: Deploy OpenSearch
      run: |
        helm upgrade --install opensearch opensearch/opensearch --namespace daap-dev  -f $(pwd)/charts/openmetadata/values-opensearch.yaml
        kubectl apply -f $(pwd)/charts/openmetadata/opensearch-sysctl-daemonset.yaml -n daap-dev

    - name: Deploy OpenMetadata (with Airflow)
      run: |
        helm upgrade --install openmetadata open-metadata/openmetadata --namespace daap-dev -f $(pwd)/charts/openmetadata/values.yaml
        helm upgrade --install airflow apache-airflow/airflow --namespace daap-dev \
          --set webserver.service.type=LoadBalancer \
          --set images.airflow.repository=daappoc25.azurecr.io/airflow \
          --set images.airflow.tag=custom \
          --set postgresql.enabled=true \
          --set postgresql.auth.username=admin \
          --set postgresql.auth.password=admin \
          --set postgresql.auth.database=airflow_db \
          --set postgresql.primary.persistence.enabled=true \
          --set postgresql.primary.persistence.size=2Gi \
          --set postgresql.primary.persistence.storageClass=managed-csi \
          --set postgresql.primary.resources.requests.memory=256Mi \
          --set postgresql.primary.resources.requests.cpu=250m \
          --set postgresql.primary.resources.limits.memory=512Mi \
          --set postgresql.primary.resources.limits.cpu=500m \
          --set airflow.triggerer.persistence.enabled=true \
          --set triggerer.persistence.size=1Gi \
          --set airflow.workers.persistence.enabled=false \
          -f $(pwd)/charts/openmetadata/airflow.yaml
        
        kubectl set env deployment/airflow-webserver -n daap-dev \
          AIRFLOW__OPENMETADATA__HOST="http://128.85.217.88:8585" \
          AIRFLOW__OPENMETADATA__API_VERSION="v1" \
          AIRFLOW__API__AUTH_BACKENDS="airflow.api.auth.backend.basic_auth" 


    - name: Show Pods & Services for Debugging
      if: failure()
      run: |
        kubectl get pods -n $NAMESPACE -o wide
        kubectl describe pods -n $NAMESPACE
        kubectl get svc -n $NAMESPACE
